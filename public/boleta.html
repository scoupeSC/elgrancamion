<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé´ Boleta de Rifa</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      gap: 16px;
    }
    .nav-bar {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 480px;
    }
    .nav-bar a {
      padding: 10px 20px;
      background: rgba(255,255,255,0.9);
      color: #2d3436;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.9em;
      transition: background 0.3s;
    }
    .nav-bar a:hover { background: white; }
    .ticket-card {
      background: white;
      border-radius: 20px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .ticket-header {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      text-align: center;
      padding: 30px 20px;
    }
    .ticket-header h1 { font-size: 1.8em; margin-bottom: 4px; }
    .ticket-header .subtitle { opacity: 0.9; font-size: 0.95em; }
    .ticket-number {
      font-size: 3em;
      font-weight: 900;
      text-align: center;
      padding: 20px;
      color: #6c5ce7;
      background: #f8f9ff;
      letter-spacing: 6px;
    }
    .ticket-body { padding: 24px; }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row .label { color: #636e72; font-size: 0.9em; }
    .info-row .value { font-weight: 600; }
    .badge-estado {
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    .badge-vendida { background: #fdecea; color: #d63031; }
    .badge-disponible { background: #e8f8f5; color: #00b894; }

    .cliente-section {
      background: #f0f0ff;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    .cliente-section h3 { color: #6c5ce7; margin-bottom: 12px; }
    .cliente-section p { margin: 4px 0; font-size: 0.95em; }

    /* Formulario de registro */
    .register-section {
      margin-top: 20px;
      padding: 20px;
      background: #fff5f5;
      border-radius: 12px;
      border: 2px dashed #d63031;
    }
    .register-section h3 { color: #d63031; margin-bottom: 12px; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.85em; color: #636e72; }
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #dfe6e9;
      border-radius: 8px;
      font-size: 0.95em;
    }
    .form-control:focus { outline: none; border-color: #6c5ce7; }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      font-size: 1em;
    }
    .btn-primary { background: #6c5ce7; color: white; }
    .btn-primary:hover { background: #5a4bd1; }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #636e72;
      font-size: 1.1em;
    }
    .error { color: #d63031; text-align: center; padding: 20px; }
    .success-msg {
      background: #e8f8f5;
      color: #00b894;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="nav-bar">
    <a href="/admin">üè† Dashboard</a>
    <a href="javascript:window.history.length > 1 ? window.history.back() : window.location.href='/admin'">‚Üê Volver</a>
  </div>
  <div class="ticket-card" id="ticketCard">
    <div class="loading" id="loadingState">
      <p>üé´ Cargando boleta...</p>
    </div>
  </div>

  <script>
    const numero = window.location.pathname.split('/').pop();

    async function loadBoleta() {
      try {
        const res = await fetch(`/api/boletas/${numero}`);
        const { success, data, error } = await res.json();

        if (!success) {
          document.getElementById('ticketCard').innerHTML = `
            <div class="error">
              <h2>‚ùå Boleta no encontrada</h2>
              <p>${error}</p>
            </div>`;
          return;
        }

        // Cargar config
        const configRes = await fetch('/api/dashboard/config');
        const configData = await configRes.json();
        const config = configData.data;

        let html = `
          <div class="ticket-header">
            <h1>üé´ ${config.nombreRifa || 'Rifa'}</h1>
            <div class="subtitle">${config.descripcion || ''}</div>
            ${config.premio ? `<div style="margin-top:8px; font-size:1.1em; font-weight:700;">üèÜ Premio: ${config.premio}</div>` : ''}
          </div>
          <div class="ticket-number">#${data.numero}</div>
          <div class="ticket-body">
            <div class="info-row">
              <span class="label">Estado</span>
              <span class="badge-estado badge-${data.estado}">${data.estado.charAt(0).toUpperCase() + data.estado.slice(1)}</span>
            </div>
            <div class="info-row">
              <span class="label">C√≥digo</span>
              <span class="value" style="font-family:monospace;">${data.codigoBarras}</span>
            </div>
            ${config.fechaSorteo ? `<div class="info-row"><span class="label">Fecha Sorteo</span><span class="value">${new Date(config.fechaSorteo).toLocaleDateString('es-CO')}</span></div>` : ''}
            ${config.precioBoleta ? `<div class="info-row"><span class="label">Precio</span><span class="value">${new Intl.NumberFormat('es-CO', {style:'currency',currency:'COP',minimumFractionDigits:0}).format(config.precioBoleta)}</span></div>` : ''}
        `;

        if (data.cliente) {
          html += `
            <div class="cliente-section">
              <h3>üë§ Datos del Comprador</h3>
              <p><strong>Nombre:</strong> ${data.cliente.nombre}</p>
              <p><strong>C√©dula:</strong> ${data.cliente.cedula}</p>
              ${data.cliente.telefono ? `<p><strong>Tel√©fono:</strong> ${data.cliente.telefono}</p>` : ''}
              ${data.cliente.email ? `<p><strong>Email:</strong> ${data.cliente.email}</p>` : ''}
              <p style="margin-top: 8px; color: #636e72; font-size: 0.85em;">
                Comprada el: ${data.fechaVenta ? new Date(data.fechaVenta).toLocaleString('es-CO') : '-'}
              </p>
            </div>
          `;
        } else {
          html += `
            <div class="register-section">
              <h3>üõí ¬°Esta boleta est√° disponible!</h3>
              <p style="margin-bottom: 16px; color: #636e72;">Complete sus datos para registrarse como comprador</p>

              <div class="form-group">
                <label>Nombre Completo *</label>
                <input type="text" class="form-control" id="reg-nombre" placeholder="Su nombre completo">
              </div>
              <div class="form-group">
                <label>C√©dula / Documento *</label>
                <input type="text" class="form-control" id="reg-cedula" placeholder="N√∫mero de documento">
              </div>
              <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" class="form-control" id="reg-telefono" placeholder="N√∫mero de tel√©fono">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" id="reg-email" placeholder="correo@ejemplo.com">
              </div>
              <button class="btn btn-primary" onclick="registrarCompra()">
                üé´ Registrar Compra
              </button>
              <div id="registerResult"></div>
            </div>
          `;
        }

        html += `
            ${config.organizador ? `<p style="margin-top:20px; text-align:center; color:#636e72; font-size:0.85em;">Organiza: ${config.organizador} ${config.telefono ? '| Tel: ' + config.telefono : ''}</p>` : ''}
          </div>
        `;

        document.getElementById('ticketCard').innerHTML = html;
      } catch (err) {
        document.getElementById('ticketCard').innerHTML = `
          <div class="error">
            <h2>‚ùå Error</h2>
            <p>${err.message}</p>
          </div>`;
      }
    }

    async function registrarCompra() {
      const nombre = document.getElementById('reg-nombre').value.trim();
      const cedula = document.getElementById('reg-cedula').value.trim();
      const telefono = document.getElementById('reg-telefono').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const resultDiv = document.getElementById('registerResult');

      if (!nombre || !cedula) {
        resultDiv.innerHTML = '<p style="color:red; margin-top:10px;">Nombre y c√©dula son obligatorios</p>';
        return;
      }

      try {
        // 1. Crear o buscar cliente
        let clienteId;
        const clienteRes = await fetch('/api/clientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, cedula, telefono, email }),
        });
        const clienteData = await clienteRes.json();

        if (clienteData.success) {
          clienteId = clienteData.data.id;
        } else if (clienteData.data && clienteData.data.id) {
          clienteId = clienteData.data.id;
        } else {
          resultDiv.innerHTML = `<p style="color:red; margin-top:10px;">${clienteData.error}</p>`;
          return;
        }

        // 2. Vender boleta
        const ventaRes = await fetch(`/api/boletas/${numero}/vender`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clienteId }),
        });
        const ventaData = await ventaRes.json();

        if (ventaData.success) {
          resultDiv.innerHTML = '<div class="success-msg">‚úÖ ¬°Registro exitoso! La boleta ha sido asignada a su nombre.</div>';
          setTimeout(() => loadBoleta(), 2000);
        } else {
          resultDiv.innerHTML = `<p style="color:red; margin-top:10px;">${ventaData.error}</p>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<p style="color:red; margin-top:10px;">Error: ${err.message}</p>`;
      }
    }

    loadBoleta();
  </script>
</body>
</html>
